import{aM as V,m as K,j as e,n as _,r as h,B as re,aW as ae}from"./vendor-CTtG1aUU.js";import{e as ne,i as ie,g as oe,f as le,s as de,b as G,d as ce,c as ue,M as me,E as b,h as E,I as A,a as C,P as w,B as j,j as H,L as Y,k as F,u as pe,l as J,m as fe,n as he,o as Q,p as v,q as xe,r as ge,t as ye,v as je,w as O,x as S,S as q,y as Se,z as Ie,A as be,C as we,D as Ne,F as Pe,G as Ee,H as Ce,J as Ae,K as I,O as Re,Q as Me,R as ve,U as ke,V as De}from"./index-B6BR6rDC.js";import{b as N,I as W}from"./Icons-BapQY1Uh.js";import{b as R,a as z,d as Fe}from"./react-dom-DtOyD6e-.js";import"./auth-DqTHE5Ot.js";import"./caption-parsing-08ziiJls.js";import"./locales-BbqYBiZD.js";import"./language-db-CHnJe_TE.js";import"./hls-CJm5oz2q.js";function Oe(t,s){return!!F().DISALLOWED_IDS.map(l=>l.split("-")).find(l=>t===l[1]&&s===l[0])}function Be(t){const{t:s}=R(),r=V(),l=K(),{error:u,value:i,loading:c}=z(async()=>{var p;const m=await ne(),d=(m==null?void 0:m.success)&&ie(m.version)&&m.allowed;if(d&&!m.hasPermission)throw new Error("extension-no-permission");const f=oe();if(f&&!d)try{await le(f)}catch{throw new Error("failed-api-metadata")}else de([...G().listSources(),...G().listEmbeds()]);let a=null;try{if(!r.media)throw new Error("no media params");a=ce(r.media)}catch{}if(!a)return null;if(Oe(a.id,a.type))throw new Error("legal");let n=null;try{n=await ue(a.type,a.id,r.season)}catch(x){if(x.status===404)return null;throw x}if(!n)return null;let y=r.episode;if(n.meta.type===me.SERIES){let x=n.meta.seasonData.episodes.find(k=>k.id===r.episode);x||(x=n.meta.seasonData.episodes[0]),y=x.id,(r.season!==n.meta.seasonData.id||r.episode!==x.id)&&l(`/media/${r.media}/${n.meta.seasonData.id}/${x.id}`,{replace:!0})}(p=t.onGetMeta)==null||p.call(t,n,y)},[]);return u&&u.message==="extension-no-permission"?e.jsx(b,{children:e.jsxs(E,{children:[e.jsx(A,{icon:N.WAND,children:s("player.metadata.extensionPermission.badge")}),e.jsx(C,{children:s("player.metadata.extensionPermission.title")}),e.jsx(w,{children:s("player.metadata.extensionPermission.text")}),e.jsx(j,{onClick:()=>{H({page:"PermissionGrant",redirectUrl:window.location.href})},theme:"purple",padding:"md:px-12 p-2.5",className:"mt-6",children:s("player.metadata.extensionPermission.button")})]})}):u&&u.message==="legal"?e.jsx(b,{children:e.jsxs(E,{children:[e.jsx(A,{icon:N.DRAGON,children:s("player.metadata.legal.badge")}),e.jsx(C,{children:s("player.metadata.legal.title")}),e.jsx(w,{children:s("player.metadata.legal.text")}),e.jsx(j,{href:"/",theme:"purple",padding:"md:px-12 p-2.5",className:"mt-6",children:s("player.metadata.failed.homeButton")})]})}):u&&u.message==="failed-api-metadata"?e.jsx(b,{children:e.jsxs(E,{children:[e.jsx(A,{icon:N.WAND,children:s("player.metadata.failed.badge")}),e.jsx(C,{children:s("player.metadata.api.text")}),e.jsx(w,{children:s("player.metadata.api.title")}),e.jsx(j,{href:"/",theme:"purple",padding:"md:px-12 p-2.5",className:"mt-6",children:s("player.metadata.failed.homeButton")})]})}):u?e.jsx(b,{children:e.jsxs(E,{children:[e.jsx(A,{icon:N.WAND,children:s("player.metadata.failed.badge")}),e.jsx(C,{children:s("player.metadata.failed.title")}),e.jsx(w,{children:s("player.metadata.failed.text")}),e.jsx(j,{href:"/",theme:"purple",padding:"md:px-12 p-2.5",className:"mt-6",children:s("player.metadata.failed.homeButton")})]})}):!i&&!c?e.jsx(b,{children:e.jsxs(E,{children:[e.jsx(A,{icon:N.WAND,children:s("player.metadata.notFound.badge")}),e.jsx(C,{children:s("player.metadata.notFound.title")}),e.jsx(w,{children:s("player.metadata.notFound.text")}),e.jsx(j,{href:"/",theme:"purple",padding:"md:px-12 p-2.5",className:"mt-6",children:s("player.metadata.notFound.homeButton")})]})}):e.jsx(b,{children:e.jsx("div",{className:"flex items-center justify-center",children:e.jsx(Y,{})})})}function $e(t){const{t:s}=R(),r=pe(c=>c.meta),l=J(c=>c.items),u=(()=>{var m,d;if(!(r!=null&&r.tmdbId))return 0;const c=l[r.tmdbId];if(!c)return 0;if(r.type==="movie")return c.progress?c.progress.watched/c.progress.duration*100:0;if(r.type==="show"&&((m=r.episode)!=null&&m.tmdbId)){const f=(d=c.episodes)==null?void 0:d[r.episode.tmdbId];return f?f.progress.watched/f.progress.duration*100:0}return 0})(),i=Math.round(u);return e.jsx(b,{children:e.jsxs(E,{children:[e.jsx(C,{children:s("player.resume.title")}),e.jsx(w,{children:s("player.resume.description",{percentage:i})}),e.jsxs("div",{className:"flex flex-col space-y-3 mt-6 w-full max-w-sm",children:[e.jsxs(j,{onClick:t.onResume,theme:"purple",padding:"md:px-12 p-2.5",className:"w-full",children:[e.jsx(W,{icon:N.PLAY,className:"mr-2"}),s("player.resume.resume")]}),e.jsxs(j,{onClick:t.onRestart,theme:"secondary",padding:"md:px-12 p-2.5",className:"w-full",children:[e.jsx(W,{icon:N.REPEAT,className:"mr-2"}),s("player.resume.restart")]}),(r==null?void 0:r.type)==="show"&&e.jsx("div",{className:"flex justify-center",children:e.jsx(fe,{controlsShowing:!1,onChange:t.onMetaChange,inControl:!0,showAsButton:!0})})]})]})})}function Le(t){const{t:s}=R(),r=he("error"),l=_(),[u,i]=h.useState("unknown"),c=Q(a=>a.setCompleted),m=v(a=>a.febboxKey),d=h.useMemo(()=>{const a=t.data;let n="";const y=xe();return n+=`URL - ${l.pathname}
`,n+=`API - ${y.length>0}

`,Object.values(a.sources).forEach(p=>{var x;n+=`${p.id}: ${p.status}
`,p.reason&&(n+=`${p.reason}
`),(x=p.error)!=null&&x.message?n+=`${p.error.name??"unknown"}: ${p.error.message}
`:p.error&&(n+=`${p.error.toString()}
`)}),n},[t,l]);if(h.useEffect(()=>{ge().then(a=>{i(a)})},[s]),u==="disallowed")return e.jsx(b,{children:e.jsxs(E,{children:[e.jsx(A,{icon:N.LOCK,children:s("player.scraping.extensionFailure.badge")}),e.jsx(C,{children:s("player.scraping.extensionFailure.title")}),e.jsx(w,{children:e.jsx(Fe,{i18nKey:"player.scraping.extensionFailure.text",components:{bold:e.jsx("span",{className:"font-bold",style:{color:"#cfcfcf"}})}})}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(j,{href:"/",theme:"secondary",padding:"md:px-12 p-2.5",className:"mt-6",children:s("player.scraping.extensionFailure.homeButton")}),e.jsx(j,{onClick:()=>{H({page:"PermissionGrant",redirectUrl:window.location.href})},theme:"purple",padding:"md:px-12 p-2.5",className:"mt-6",children:s("player.scraping.extensionFailure.enableExtension")})]})]})});function f(){c(!1),window.location.reload()}return e.jsxs(b,{children:[e.jsxs(E,{children:[e.jsx(A,{icon:N.WAND,children:s("player.scraping.notFound.badge")}),e.jsx(C,{children:s("player.scraping.notFound.title")}),e.jsx(w,{children:s("player.scraping.notFound.text")}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(j,{href:"/",theme:"secondary",padding:"md:px-12 p-2.5",className:"mt-6",children:s("player.scraping.notFound.homeButton")}),e.jsx(j,{onClick:()=>r.show(),theme:"purple",padding:"md:px-12 p-2.5",className:"mt-6",children:s("player.scraping.notFound.detailsButton")})]}),(!je()||!m)&&F().HAS_ONBOARDING?e.jsxs("div",{className:"flex flex-col max-w-md gap-3 items-center py-3",children:[e.jsx(w,{children:s("player.scraping.notFound.onboarding")}),e.jsx(j,{onClick:()=>f(),theme:"purple",className:"w-fit",children:s("player.scraping.notFound.onboardingButton")})]}):null]}),d?e.jsx(ye,{id:r.id,onClose:()=>r.hide(),error:d}):null]})}function Te(t){const{t:s}=R(),r=s("player.menus.sources.unknownOption"),l=h.useMemo(()=>{if(!t.embedId)return r;const m=O().find(d=>d.id===t.embedId);return(m==null?void 0:m.name)??r},[t.embedId,r]),{run:u,errored:i,loading:c}=Ie(t.routerId,t.sourceId,t.url,t.embedId);return e.jsx(q,{loading:c,error:i,onClick:u,children:e.jsx("span",{className:"flex flex-col",children:e.jsx("span",{children:l})})})}function Ue(t){const{t:s}=R(),{run:r,notfound:l,loading:u,items:i,errored:c}=Se(t.sourceId,t.routerId),m=h.useMemo(()=>{if(!t.sourceId)return"...";const a=O().find(n=>n.id===t.sourceId);return(a==null?void 0:a.name)??"..."},[t.sourceId]),d=h.useRef(null);h.useEffect(()=>{d.current!==t.sourceId&&(d.current=t.sourceId,t.sourceId&&r())},[r,t.sourceId]);let f=null;return u?f=e.jsx(S.TextDisplay,{noIcon:!0,children:e.jsx(Y,{})}):l?f=e.jsx(S.TextDisplay,{title:s("player.menus.sources.noStream.title")??void 0,children:s("player.menus.sources.noStream.text")}):(i==null?void 0:i.length)===0?f=e.jsx(S.TextDisplay,{title:s("player.menus.sources.noEmbeds.title")??void 0,children:s("player.menus.sources.noEmbeds.text")}):c?f=e.jsx(S.TextDisplay,{title:s("player.menus.sources.failed.title")??void 0,children:s("player.menus.sources.failed.text")}):i&&t.sourceId&&(f=i.map(a=>e.jsx(Te,{embedId:a.embedId,url:a.url,routerId:t.routerId,sourceId:t.sourceId},`${a.embedId}-${a.url}`))),e.jsxs(e.Fragment,{children:[e.jsx(S.BackLink,{onClick:t.onBack,children:m}),e.jsx(S.Section,{children:f})]})}function Ge(t){const{t:s}=R(),[r,l]=re.useState(null),u="manualSourceSelect",i=v(d=>d.sourceOrder),c=v(d=>d.enableSourceOrder),m=h.useMemo(()=>{const d=t.media.type;if(!d)return[];const f=O().filter(y=>y.type==="source").filter(y=>{var p;return(p=y.mediaTypes)==null?void 0:p.includes(d)});if(!c||i.length===0)return f;const a=[],n=[...f];for(const y of i){const p=n.findIndex(x=>x.id===y);p!==-1&&(a.push(n[p]),n.splice(p,1))}return a.push(...n),a},[t.media.type,i,c]);return r?e.jsx("div",{className:"h-full w-full flex items-center justify-center",children:e.jsx("div",{className:"w-full max-w-md h-[50vh] flex flex-col",children:e.jsx(S.CardWithScrollable,{children:e.jsx(Ue,{sourceId:r,routerId:u,onBack:()=>l(null)})})})}):e.jsx("div",{className:"h-full w-full flex items-center justify-center",children:e.jsx("div",{className:"w-full max-w-md h-[50vh] flex flex-col",children:e.jsxs(S.CardWithScrollable,{children:[e.jsx(S.Title,{children:s("player.menus.sources.title")}),e.jsx(S.Section,{className:"pb-4",children:m.map(d=>e.jsx(q,{onClick:()=>l(d.id),children:d.name},d.id))})]})})})}async function We(){return!(!F().HAS_ONBOARDING||await be()||we.getState().proxySet||Q.getState().completed)}function Ve(t){const s=t??"";if(!!!s.match(/^\d+(:\d+)*$/))return null;const l=s.split(":").map(Number).reverse(),u=l[2]??0,i=Math.min(l[1]??0,59),c=Math.min(l[0]??0,i>0?59:1/0);return u*60*60+i*60+c}function Ke(){const t=K(),s=V(),[r,l]=h.useState(null),[u]=Ne("t"),{status:i,playMedia:c,reset:m,setScrapeNotFound:d,shouldStartFromBeginning:f,setShouldStartFromBeginning:a,setStatus:n}=Pe(),{setPlayerMeta:y,scrapeMedia:p}=Ee(),x=Ce(),k=v(o=>o.manualSourceSelection),B=Ae("settings"),D=h.useRef(!1),$=J(o=>o.items),X=JSON.stringify({media:s.media,season:s.season,episode:s.episode});h.useEffect(()=>{m(),D.current=!1},[X,m]),h.useEffect(()=>{D.current||i===I.PLAYING&&new URLSearchParams(window.location.search).has("watchparty")&&setTimeout(()=>{B.navigate("/watchparty"),D.current=!0},1e3)},[i,B]);const L=h.useCallback(o=>{var g,P;(o==null?void 0:o.type)==="show"?t(`/media/${s.media}/${(g=o.season)==null?void 0:g.tmdbId}/${(P=o.episode)==null?void 0:P.tmdbId}`):t(`/media/${s.media}`)},[t,s]),T=h.useCallback(o=>{var P,U;if(!(o!=null&&o.tmdbId))return!1;const g=$[o.tmdbId];if(!g)return!1;if(o.type==="movie")return g.progress?g.progress.watched/g.progress.duration*100>80:!1;if(o.type==="show"&&((P=o.episode)!=null&&P.tmdbId)){const M=(U=g.episodes)==null?void 0:U[o.episode.tmdbId];return M?M.progress.watched/M.progress.duration*100>80:!1}return!1},[$]),Z=h.useCallback((o,g)=>{const P=y(o,g);P&&T(P)&&n(I.RESUME)},[T,n,y]),ee=h.useCallback(()=>{n(I.SCRAPING)},[n]),se=h.useCallback(()=>{a(!0),n(I.SCRAPING)},[a,n]),te=h.useCallback(o=>{if(!o)return;let g;u&&(g=Ve(u)??void 0),c(Re(o),Me(o.stream.captions),o.sourceId,f?0:g),a(!1)},[c,u,f,a]);return e.jsxs(ve,{backUrl:x,onMetaChange:L,children:[i===I.IDLE?e.jsx(Be,{onGetMeta:Z}):null,i===I.RESUME?e.jsx($e,{onResume:ee,onRestart:se,onMetaChange:L}):null,i===I.SCRAPING&&p?k?e.jsx(Ge,{media:p}):e.jsx(ke,{media:p,onResult:(o,g)=>{l({sourceOrder:g,sources:o}),d()},onGetStream:te}):null,i===I.SCRAPE_NOT_FOUND&&r?e.jsx(Le,{data:r}):null,i===I.PLAYBACK_ERROR?e.jsx(De,{}):null]})}function ss(){const t=_(),{loading:s,error:r,value:l}=z(()=>We());if(r)throw new Error("Failed to detect onboarding");return s?null:l?e.jsx(ae,{replace:!0,to:{pathname:"/onboarding",search:`redirect=${encodeURIComponent(t.pathname)}`}}):e.jsx(Ke,{})}export{ss as PlayerView,Ke as RealPlayerView,ss as default};
