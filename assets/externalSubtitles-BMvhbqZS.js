const f={baseUrl:"https://libre-subs.fifthwit.net"};async function w({tmdb_id:e,imdb_id:n,season:t,episode:i,encoding:a,language:s,format:o,source:r,hi:l,...d}){const h=new URL(`${f.baseUrl}/search`),g={id:String(e||n),season:t,episode:i,encoding:Array.isArray(a)?a.join(","):a,language:Array.isArray(s)?s.join(","):s,format:Array.isArray(o)?o.join(","):o,source:Array.isArray(r)?r.join(","):r,hi:l};return Object.entries(g).forEach(([p,c])=>{c!==void 0&&h.searchParams.append(p,String(c))}),Object.entries(d).forEach(([p,c])=>{c!==void 0&&(Array.isArray(c)?h.searchParams.append(p,c.join(",")):h.searchParams.append(p,String(c)))}),h}async function S(e){const n=await fetch(e.toString());if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);return n.json()}async function k(e){try{const n=await w(e);return await S(n)}catch(n){throw new Error(`Error fetching subtitles: ${n}`)}}function P(e){return{English:"en",Spanish:"es",French:"fr",German:"de",Italian:"it",Portuguese:"pt",Russian:"ru",Japanese:"ja",Korean:"ko",Chinese:"zh",Arabic:"ar",Hindi:"hi",Turkish:"tr",Dutch:"nl",Polish:"pl",Swedish:"sv",Norwegian:"no",Danish:"da",Finnish:"fi",Greek:"el",Hebrew:"he",Thai:"th",Vietnamese:"vi",Indonesian:"id",Malay:"ms",Filipino:"tl",Ukrainian:"uk",Romanian:"ro",Czech:"cs",Hungarian:"hu",Bulgarian:"bg",Croatian:"hr",Serbian:"sr",Slovak:"sk",Slovenian:"sl",Estonian:"et",Latvian:"lv",Lithuanian:"lt",Icelandic:"is",Maltese:"mt",Georgian:"ka",Armenian:"hy",Azerbaijani:"az",Kazakh:"kk",Kyrgyz:"ky",Uzbek:"uz",Tajik:"tg",Turkmen:"tk",Mongolian:"mn",Persian:"fa",Urdu:"ur",Bengali:"bn",Tamil:"ta",Telugu:"te",Marathi:"mr",Gujarati:"gu",Kannada:"kn",Malayalam:"ml",Punjabi:"pa",Sinhala:"si",Nepali:"ne",Burmese:"my",Khmer:"km",Lao:"lo",Tibetan:"bo",Uyghur:"ug",Kurdish:"ku",Pashto:"ps",Dari:"prs",Sindhi:"sd",Kashmiri:"ks",Dogri:"doi",Konkani:"kok",Manipuri:"mni",Bodo:"brx",Sanskrit:"sa",Santhali:"sat",Maithili:"mai",Bhojpuri:"bho",Awadhi:"awa",Chhattisgarhi:"hne",Magahi:"mag",Rajasthani:"raj",Malvi:"mup",Bundeli:"bns",Bagheli:"bfy",Pahari:"phr",Kumaoni:"kfy",Garhwali:"gbm",Kangri:"xnr"}[e]||e.toLowerCase()}async function z(e,n,t,i){try{const a={encoding:"utf-8",source:"all",imdb_id:n};return e&&!n&&(a.tmdb_id=typeof e=="string"?parseInt(e,10):e),t&&i&&(a.season=t,a.episode=i),console.log("Searching Wyzie subtitles with params:",a),(await k(a)).map(r=>({id:r.id,language:r.language,url:r.url,type:r.format==="srt"||r.format==="vtt"?r.format:"srt",needsProxy:!1,opensubtitles:!0,display:r.display,media:r.media,isHearingImpaired:r.isHearingImpaired,source:`wyzie ${r.source.toString()==="opensubtitles"?"opensubs":r.source}`,encoding:r.encoding}))}catch(a){return console.error("Error fetching Wyzie subtitles:",a),[]}}async function j(e,n,t){try{const i=`https://rest.opensubtitles.org/search/${n&&t?`episode-${t}/`:""}imdbid-${e.slice(2)}${n&&t?`/season-${n}`:""}`,a=await fetch(i,{headers:{"X-User-Agent":"VLSub 0.10.2"}});if(!a.ok)throw new Error(`OpenSubtitles API returned ${a.status}`);const s=await a.json(),o=[];for(const r of s){const l=r.SubDownloadLink.replace(".gz","").replace("download/","download/subencoding-utf8/"),d=P(r.LanguageName);!l||!d||o.push({id:l,language:d,url:l,type:r.SubFormat||"srt",needsProxy:!1,opensubtitles:!0,source:"opensubs"})}return o}catch(i){return console.error("Error fetching OpenSubtitles:",i),[]}}async function A(e){var n,t;try{const i=e.imdbId;if(!i)return console.log("No IMDb ID available for external subtitle scraping"),[];const a=(n=e.season)==null?void 0:n.number,s=(t=e.episode)==null?void 0:t.number,o=e.tmdbId,r=1e4,l=z(o,i,a,s),d=j(i,a,s),h=new Promise(u=>{setTimeout(()=>u([]),r)}),g=[];let p=0;const c=3,m=(u,y)=>{g.push(...y),p+=1,console.log(`${u} completed with ${y.length} captions (${p}/${c} sources done)`)},b=[Promise.race([l,h]).then(u=>(m("Wyzie",u),u)),Promise.race([d,h]).then(u=>(m("OpenSubtitles",u),u))];return await Promise.allSettled(b),console.log(`Found ${g.length} total external captions from all sources`),g}catch(i){return console.error("Error in scrapeExternalSubtitles:",i),[]}}export{A as scrapeExternalSubtitles,j as scrapeOpenSubtitlesCaptions,z as scrapeWyzieCaptions};
